<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DeliveryTrack - Gesti√≥n de Env√≠os</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Reset global */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Estilos base */
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f0f0;
      transition: background-color 0.3s ease, background-image 0.3s ease;
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
    }

    /* Contenedor principal */
    .app-container {
      width: 100%;
      max-width: 100vw;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
      background-color: rgba(255, 255, 255, 0.85);
    }

    body.dark-theme .app-container {
      background-color: rgba(0, 0, 0, 0.85);
    }

    /* Estilos para temas */
    body.dark-theme {
      background-color: #222;
      color: #eee;
    }

    body.dark-theme .pedido-card {
      background: #333;
      color: #eee;
    }

    body.dark-theme .stats-bar,
    body.dark-theme .modal-content {
      background: #444;
      color: #eee;
    }

    body.dark-theme input,
    body.dark-theme textarea,
    body.dark-theme select {
      background-color: #555;
      color: #eee;
      border-color: #666;
    }

    body.orange-theme {
      background-color: #fff8f0;
    }

    body.orange-theme .pedido-card {
      background: linear-gradient(135deg, #ffe8d6 0%, #ffd1a4 100%);
    }

    body.orange-theme .pedido-card:nth-child(even) {
      background: linear-gradient(135deg, #ffdfc4 0%, #ffb347 100%);
    }

    /* Men√∫ Hamburguesa */
    .menu-container {
      position: fixed;
      top: 10px;
      left: 0;
      z-index: 1000;
      padding-left: 10px;
    }

    .hamburger-menu {
      width: 30px;
      height: 25px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
      z-index: 1001;
    }

    .hamburger-menu .bar {
      height: 3px;
      width: 100%;
      background-color: #FF6B35;
      transition: all 0.3s ease;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: -300px;
      width: 280px;
      height: 100vh;
      background-color: white;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      transition: all 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar h3, .sidebar h4 {
      color: #333;
      margin-top: 20px;
    }

    .sidebar button {
      background-color: #FF6B35;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .theme-selector select {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border-radius: 5px;
      border: 1px solid #ddd;
    }

    /* Barra de estad√≠sticas mejorada */
    .stats-bar {
      display: flex;
      justify-content: space-around;
      padding: 15px;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(5px);
    }

    .stat-card {
      text-align: center;
      padding: 10px;
      border-radius: 10px;
      min-width: 90px;
    }

    .stat-card i {
      font-size: 28px;
      color: #FF6B35;
      margin-bottom: 5px;
    }

    .stat-card span {
      display: block;
      font-size: 32px;
      font-weight: bold;
      color: #333;
    }

    .stat-card p {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }

    body.dark-theme .stat-card span {
      color: #eee;
    }

    body.dark-theme .stat-card p {
      color: #ccc;
    }

    /* Lista de pedidos */
    .pedidos-container {
      padding: 20px;
      margin-top: 20px;
    }

    .pedido-card {
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      background: linear-gradient(135deg, #F8EDEB 0%, #F9DCC4 100%);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .pedido-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    /* Color alterno para tarjetas pares */
    .pedido-card:nth-child(even) {
      background: linear-gradient(135deg, #E8F7EE 0%, #D4EDE1 100%);
    }

    .pedido-card h3 {
      margin: 0;
      color: #333;
    }

    .pedido-card p {
      margin: 5px 0;
      color: #666;
    }

    .pedido-card small {
      color: #999;
    }

    .botones-accion {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .pedido-card button {
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      flex-grow: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      min-width: 120px;
    }

    .btn-en-camino {
      background: #FFA500;
      color: white;
    }

    .btn-entregado {
      background: #4CAF50;
      color: white;
    }

    .btn-no-entregado {
      background: #ff4444;
      color: white;
    }

    .btn-archivar {
      background: #6c757d !important;
      color: white !important;
    }

    /* Bot√≥n flotante mejorado */
    .floating-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: #FF6B35;
      color: white;
      border: none;
      font-size: 30px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .floating-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .close-btn {
      float: right;
      font-size: 24px;
      cursor: pointer;
      color: #777;
    }

    form input, form textarea, form select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: inherit;
    }

    form textarea {
      resize: vertical;
      min-height: 80px;
    }

    .modal-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      gap: 10px;
    }

    .modal-actions button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-cancelar {
      background: #e0e0e0;
      color: #333;
    }

    .modal-actions button[type="submit"] {
      background: #FF6B35;
      color: white;
    }

    /* Historial */
    #historial-list .pedido-card {
      background: #f8f9fa;
      margin-bottom: 10px;
    }

    /* Estado del pedido */
    .estado-pedido {
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8em;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: inline-block;
    }
    
    .estado-pendiente {
      background-color: #FFF3CD;
      color: #856404;
      border-left: 4px solid #FFC107;
    }
    
    .estado-en_camino {
      background-color: #E7F1FF;
      color: #0D6EFD;
      border-left: 4px solid #0D6EFD;
    }
    
    .estado-entregado {
      background-color: #D1E7DD;
      color: #0F5132;
      border-left: 4px solid #198754;
    }

    .estado-no_entregado {
      background-color: #F8D7DA;
      color: #721C24;
      border-left: 4px solid #DC3545;
    }

    /* Search input mejorado */
    .search-input {
      width: 90%;
      padding: 12px 20px;
      margin: 15px auto;
      display: block;
      border: 1px solid #ddd;
      border-radius: 25px;
      font-size: 16px;
      background-color: rgba(255, 255, 255, 0.9);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      border-color: #FF6B35;
    }

    /* Configuraci√≥n de fondo */
    .background-settings {
      margin-top: 20px;
      padding: 15px;
      background-color: #f5f5f5;
      border-radius: 8px;
    }

    .background-settings h4 {
      margin-bottom: 10px;
    }

    .background-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .background-option {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .background-option input[type="file"] {
      display: none;
    }

    .background-option label {
      padding: 8px 12px;
      background-color: #FF6B35;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      display: inline-block;
    }

    .background-option button {
      padding: 8px 12px;
      background-color: #6c757d;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    /* Cliente frecuente */
    .cliente-frecuente {
      background-color: #d4edda;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      display: none;
    }

    .cliente-frecuente p {
      margin: 5px 0;
    }

    .cliente-frecuente button {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      margin-top: 5px;
    }

    /* Virtualizaci√≥n de listas */
    .virtual-list-container {
      height: 60vh;
      overflow-y: auto;
      position: relative;
    }

    .virtual-list {
      position: relative;
      height: 100%;
    }

    .virtual-list-item {
      position: absolute;
      width: 100%;
      box-sizing: border-box;
    }

    /* Loading spinner */
    .loading-spinner {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #FF6B35;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Vendedores section */
    .vendedores-section {
      margin-top: 20px;
    }

    .add-vendedor {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 15px;
    }

    .add-vendedor input {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ddd;
    }

    #add-vendedor-btn {
      background-color: #FF6B35;
      color: white;
      border: none;
      padding: 8px;
      border-radius: 5px;
      cursor: pointer;
    }

    #vendedores-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #vendedores-list li {
      padding: 10px;
      background-color: #f5f5f5;
      margin-bottom: 5px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #vendedores-list li button {
      background-color: #ff4444;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 2px 5px;
      cursor: pointer;
      font-size: 12px;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Submenu de historial */
    .historial-submenu {
      display: none;
      padding-left: 15px;
      margin-bottom: 10px;
    }

    .historial-submenu.active {
      display: block;
    }

    .historial-submenu button {
      background-color: #e67e22;
      margin: 5px 0;
    }

    /* Calendario en historial */
    .calendar-container {
      margin: 15px 0;
      text-align: center;
    }

    #historial-date {
      width: 100%;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ddd;
    }

    .historial-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }

    .historial-actions button {
      width: 48%;
    }

    /* Modal de confirmaci√≥n de entrega */
    .confirmacion-entrega {
      text-align: center;
      padding: 20px;
    }

    .confirmacion-entrega h3 {
      margin-bottom: 20px;
    }

    .confirmacion-botones {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 30px;
    }

    .confirmacion-botones button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      min-width: 120px;
    }

    .btn-confirmar-entrega {
      background-color: #4CAF50;
      color: white;
    }

    .btn-negar-entrega {
      background-color: #f44336;
      color: white;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Men√∫ Hamburguesa -->
    <div class="menu-container">
      <div class="hamburger-menu" id="hamburger-menu">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
      </div>
      
      <div class="sidebar" id="sidebar">
        <h3>DeliveryTrack 2331</h3>
        
        <button id="show-historial-btn">
          <i class="fas fa-history"></i> Ver Historial
        </button>
        
        <div class="historial-submenu" id="historial-submenu">
          <button id="show-calendar-btn">
            <i class="fas fa-calendar"></i> Calendario
          </button>
          <button id="show-recent-btn">
            <i class="fas fa-clock"></i> Historial Reciente
          </button>
        </div>
        
        <div class="theme-selector">
          <h4>Tema</h4>
          <select id="theme-select">
            <option value="light">Claro</option>
            <option value="dark">Oscuro</option>
            <option value="orange">Naranja</option>
          </select>
        </div>
        
        <div class="background-settings">
          <h4>Fondo de Pantalla</h4>
          <div class="background-options">
            <div class="background-option">
              <input type="file" id="background-upload" accept="image/*">
              <label for="background-upload"><i class="fas fa-upload"></i> Personalizar</label>
            </div>
            <div class="background-option">
              <button id="reset-background"><i class="fas fa-trash"></i> Restablecer</button>
            </div>
          </div>
        </div>
        
        <div class="vendedores-section">
          <h4>Vendedores</h4>
          <div class="add-vendedor">
            <input type="text" id="vendedor-nombre-input" placeholder="Nombre">
            <input type="tel" id="vendedor-telefono-input" placeholder="Tel√©fono (8 d√≠gitos)" pattern="[0-9]{8}">
            <button id="add-vendedor-btn">Agregar</button>
          </div>
          <ul id="vendedores-list"></ul>
        </div>
        
        <button onclick="document.getElementById('sidebar').classList.remove('active')">
          <i class="fas fa-times"></i> Cerrar Men√∫
        </button>
      </div>
    </div>

    <!-- Barra de Estad√≠sticas Mejorada -->
    <div class="stats-bar">
      <div class="stat-card">
        <i class="fas fa-box-open"></i>
        <span id="total-pedidos">0</span>
        <p>Total</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-truck-loading"></i>
        <span id="pendientes">0</span>
        <p>Pendientes</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-check-double"></i>
        <span id="entregados">0</span>
        <p>Entregados</p>
      </div>
    </div>

    <!-- Search input mejorado -->
    <input type="text" id="buscar-pedido" placeholder="Buscar pedidos..." class="search-input">

    <!-- Lista de Pedidos -->
    <div class="pedidos-container" id="pedidos-list">
      <!-- Tarjetas generadas din√°micamente -->
    </div>

    <!-- Loading spinner -->
    <div class="loading-spinner" id="loading-spinner">
      <div class="spinner"></div>
      <p>Cargando...</p>
    </div>

    <!-- Bot√≥n Flotante Mejorado -->
    <button class="floating-btn" id="add-pedido-btn">
      <i class="fas fa-plus"></i>
    </button>

    <!-- Modal de Registro con detecci√≥n de cliente frecuente - FORMULARIO CORREGIDO -->
    <div class="modal" id="registro-modal">
      <div class="modal-content">
        <h2>Nuevo Pedido</h2>
        <form id="pedido-form">
          <input type="text" id="cliente-nombre" placeholder="Nombre del Cliente" required>
          <input type="text" id="cliente-direccion" placeholder="Direcci√≥n" required>
          <input type="tel" id="cliente-telefono" placeholder="Tel√©fono del Cliente (8 d√≠gitos)" 
                 pattern="[0-9]{8}" title="Por favor ingrese 8 d√≠gitos sin espacios ni guiones" required>
          
          <div class="cliente-frecuente" id="cliente-frecuente">
            <p>Cliente frecuente encontrado:</p>
            <p id="cliente-info"></p>
            <button type="button" id="usar-cliente-btn">Usar esta informaci√≥n</button>
          </div>
          
          <textarea id="cliente-productos" placeholder="Productos a enviar" required></textarea>
          <input list="vendedores-data" name="vendedor" id="vendedor-nombre" placeholder="Nombre del Vendedor" required>
          <datalist id="vendedores-data"></datalist>
          <input type="tel" id="vendedor-telefono" placeholder="Tel√©fono del Vendedor (8 d√≠gitos)" 
                 pattern="[0-9]{8}" title="Por favor ingrese 8 d√≠gitos sin espacios ni guiones" required>
          <div class="modal-actions">
            <button type="submit">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal de Historial con virtualizaci√≥n -->
    <div class="modal" id="historial-modal">
      <div class="modal-content">
        <span class="close-btn" id="close-historial">&times;</span>
        <h2 id="historial-title">Pedidos Archivados</h2>
        <div class="calendar-container" id="calendar-container" style="display: none;">
          <input type="date" id="historial-date">
          <div class="historial-actions">
            <button id="filter-date-btn">Filtrar por fecha</button>
            <button id="show-all-historial">Mostrar todos</button>
          </div>
        </div>
        <div class="virtual-list-container">
          <div id="historial-list" class="virtual-list"></div>
        </div>
      </div>
    </div>

    <!-- Modal de Confirmaci√≥n de Entrega -->
    <div class="modal" id="confirmacion-entrega-modal">
      <div class="modal-content">
        <div class="confirmacion-entrega">
          <h3>¬øEl pedido fue entregado?</h3>
          <p>Confirma el estado de entrega del pedido</p>
          
          <div class="confirmacion-botones">
            <button class="btn-confirmar-entrega" id="confirmar-entrega-btn">
              <i class="fas fa-check-circle"></i> Entregado
            </button>
            <button class="btn-negar-entrega" id="negar-entrega-btn">
              <i class="fas fa-times-circle"></i> No Entregado
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Datos
    let pedidos = JSON.parse(localStorage.getItem('pedidos')) || [];
    let historial = JSON.parse(localStorage.getItem('historial')) || [];
    let vendedores = JSON.parse(localStorage.getItem('vendedores')) || [];
    let currentTheme = localStorage.getItem('theme') || 'light';
    let backgroundImage = localStorage.getItem('backgroundImage') || '';
    let searchTimeout = null;
    let currentPedidoId = null; // Para almacenar el ID del pedido durante la confirmaci√≥n

    // Elementos del DOM
    const pedidosList = document.getElementById('pedidos-list');
    const addPedidoBtn = document.getElementById('add-pedido-btn');
    const registroModal = document.getElementById('registro-modal');
    const pedidoForm = document.getElementById('pedido-form');
    const historialModal = document.getElementById('historial-modal');
    const closeHistorialBtn = document.getElementById('close-historial');
    const historialList = document.getElementById('historial-list');
    const searchInput = document.getElementById('buscar-pedido');
    const showHistorialBtn = document.getElementById('show-historial-btn');
    const historialSubmenu = document.getElementById('historial-submenu');
    const showCalendarBtn = document.getElementById('show-calendar-btn');
    const showRecentBtn = document.getElementById('show-recent-btn');
    const calendarContainer = document.getElementById('calendar-container');
    const historialDate = document.getElementById('historial-date');
    const filterDateBtn = document.getElementById('filter-date-btn');
    const showAllHistorial = document.getElementById('show-all-historial');
    const historialTitle = document.getElementById('historial-title');
    const clienteTelefonoInput = document.getElementById('cliente-telefono');
    const clienteNombreInput = document.getElementById('cliente-nombre');
    const clienteDireccionInput = document.getElementById('cliente-direccion');
    const clienteProductosInput = document.getElementById('cliente-productos');
    const clienteFrecuenteDiv = document.getElementById('cliente-frecuente');
    const clienteInfoDiv = document.getElementById('cliente-info');
    const usarClienteBtn = document.getElementById('usar-cliente-btn');
    const backgroundUpload = document.getElementById('background-upload');
    const resetBackgroundBtn = document.getElementById('reset-background');
    const loadingSpinner = document.getElementById('loading-spinner');
    const vendedorNombreInput = document.getElementById('vendedor-nombre');
    const vendedorTelefonoInput = document.getElementById('vendedor-telefono');
    const confirmacionEntregaModal = document.getElementById('confirmacion-entrega-modal');
    const confirmarEntregaBtn = document.getElementById('confirmar-entrega-btn');
    const negarEntregaBtn = document.getElementById('negar-entrega-btn');

    // Variables para virtualizaci√≥n
    const ITEM_HEIGHT = 180; // Altura estimada de cada elemento del historial
    let visibleItems = [];
    let scrollTop = 0;

    // Configurar fondo de pantalla
    function setupBackground() {
      if (backgroundImage) {
        document.body.style.backgroundImage = `url(${backgroundImage})`;
      }
      
      backgroundUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            backgroundImage = event.target.result;
            localStorage.setItem('backgroundImage', backgroundImage);
            document.body.style.backgroundImage = `url(${backgroundImage})`;
          };
          reader.readAsDataURL(file);
        }
      });
      
      resetBackgroundBtn.addEventListener('click', () => {
        backgroundImage = '';
        localStorage.removeItem('backgroundImage');
        document.body.style.backgroundImage = '';
      });
    }

    // Funci√≥n para enviar WhatsApp
    function enviarWhatsApp(numero, mensaje) {
      const url = `https://wa.me/+503${numero}?text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');
    }

    // Actualizar estad√≠sticas
    function actualizarEstadisticas() {
      document.getElementById('total-pedidos').textContent = pedidos.length;
      document.getElementById('pendientes').textContent = pedidos.filter(p => p.estado !== 'entregado').length;
      document.getElementById('entregados').textContent = pedidos.filter(p => p.estado === 'entregado').length;
    }

    // Formatear fecha
    function formatearFecha(fecha) {
      if (!fecha) return 'Fecha no disponible';
      if (typeof fecha === 'string') return fecha;
      
      const opciones = { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      return fecha.toLocaleString('es-SV', opciones);
    }

    // Comparar fechas sin horas
    function compareDates(date1, date2) {
      const d1 = new Date(date1);
      const d2 = new Date(date2);
      
      return d1.getFullYear() === d2.getFullYear() && 
             d1.getMonth() === d2.getMonth() && 
             d1.getDate() === d2.getDate();
    }

    // Buscar cliente frecuente
    function buscarClienteFrecuente(telefono) {
      if (!telefono || telefono.length !== 8) {
        clienteFrecuenteDiv.style.display = 'none';
        return;
      }
      
      // Buscar en el historial primero
      const clienteEnHistorial = historial.find(p => p.telefono === telefono);
      if (clienteEnHistorial) {
        mostrarInfoCliente(clienteEnHistorial);
        return;
      }
      
      // Si no est√° en historial, buscar en pedidos activos
      const clienteEnPedidos = pedidos.find(p => p.telefono === telefono);
      if (clienteEnPedidos) {
        mostrarInfoCliente(clienteEnPedidos);
      }
    }

    // Mostrar informaci√≥n de cliente frecuente
    function mostrarInfoCliente(cliente) {
      clienteInfoDiv.innerHTML = `
        <strong>Nombre:</strong> ${cliente.cliente}<br>
        <strong>Direcci√≥n:</strong> ${cliente.direccion}
      `;
      clienteFrecuenteDiv.style.display = 'block';
    }

    // Usar informaci√≥n de cliente frecuente
    function usarInfoCliente() {
      const telefono = clienteTelefonoInput.value;
      let cliente = historial.find(p => p.telefono === telefono);
      if (!cliente) {
        cliente = pedidos.find(p => p.telefono === telefono);
      }
      
      if (cliente) {
        clienteNombreInput.value = cliente.cliente;
        clienteDireccionInput.value = cliente.direccion;
        clienteFrecuenteDiv.style.display = 'none';
      }
    }

    // Renderizar lista de pedidos
    function renderizarPedidos(lista = pedidos) {
      pedidosList.innerHTML = '';
      
      if (lista.length === 0) {
        pedidosList.innerHTML = '<p>No hay pedidos activos. Agrega uno nuevo.</p>';
        actualizarEstadisticas();
        return;
      }
      
      // Ordenar pedidos: pendientes primero, luego en camino, luego entregados
      const pedidosOrdenados = [...lista].sort((a, b) => {
        const ordenEstados = { 'pendiente': 1, 'en_camino': 2, 'entregado': 3, 'no_entregado': 4 };
        return ordenEstados[a.estado] - ordenEstados[b.estado];
      });

      pedidosOrdenados.forEach(pedido => {
        const pedidoCard = document.createElement('div');
        pedidoCard.className = 'pedido-card';
        
        // Determinar texto y clase del estado
        let estadoTexto, estadoClase;
        switch(pedido.estado) {
          case 'en_camino':
            estadoTexto = 'En camino';
            estadoClase = 'estado-en_camino';
            break;
          case 'entregado':
            estadoTexto = 'Entregado';
            estadoClase = 'estado-entregado';
            break;
          case 'no_entregado':
            estadoTexto = 'No entregado';
            estadoClase = 'estado-no_entregado';
            break;
          default:
            estadoTexto = 'Pendiente';
            estadoClase = 'estado-pendiente';
        }
        
        pedidoCard.innerHTML = `
          <h3>${pedido.cliente}</h3>
          <p>${pedido.direccion}</p>
          <p>Tel: +503${pedido.telefono}</p>
          <p>Productos: ${pedido.productos}</p>
          <p>Vendedor: ${pedido.vendedor} (Tel: +503${pedido.telefonoVendedor})</p>
          <p>Estado: <span class="estado-pedido ${estadoClase}">${estadoTexto}</span></p>
          <p><small>Creado: ${formatearFecha(pedido.fechaCreacion)}</small></p>
          <div class="botones-accion">
            ${pedido.estado === 'entregado' ? 
              `<button class="btn-archivar" onclick="archivarPedido(${pedido.id})">
                <i class="fas fa-archive"></i> Archivar
              </button>` : 
              `<button class="btn-en-camino" onclick="cambiarEstado(${pedido.id}, 'en_camino')">
                <i class="fas fa-truck"></i> En camino
              </button>`
            }
            <button class="btn-entregado" onclick="mostrarConfirmacionEntrega(${pedido.id})">
              <i class="fas fa-check-circle"></i> ${pedido.estado === 'entregado' ? 'Entregado' : 'Entregar'}
            </button>
          </div>
        `;
        pedidosList.appendChild(pedidoCard);
      });
      actualizarEstadisticas();
      guardarDatos();
    }

    // Mostrar modal de confirmaci√≥n de entrega
    window.mostrarConfirmacionEntrega = (id) => {
      currentPedidoId = id;
      confirmacionEntregaModal.style.display = 'flex';
    };

    // Configurar botones de confirmaci√≥n de entrega
    function setupConfirmacionEntrega() {
      confirmarEntregaBtn.addEventListener('click', () => {
        cambiarEstado(currentPedidoId, 'entregado');
        confirmacionEntregaModal.style.display = 'none';
      });

      negarEntregaBtn.addEventListener('click', () => {
        cambiarEstado(currentPedidoId, 'no_entregado');
        confirmacionEntregaModal.style.display = 'none';
      });

      // Cerrar modal al hacer clic fuera
      window.addEventListener('click', (e) => {
        if (e.target === confirmacionEntregaModal) {
          confirmacionEntregaModal.style.display = 'none';
        }
      });
    }

    // Virtualizaci√≥n de lista para el historial
    function setupVirtualList() {
      const container = document.querySelector('.virtual-list-container');
      const list = document.getElementById('historial-list');
      
      function renderVisibleItems() {
        scrollTop = container.scrollTop;
        const startIndex = Math.floor(scrollTop / ITEM_HEIGHT);
        const endIndex = Math.min(startIndex + Math.ceil(container.clientHeight / ITEM_HEIGHT) + 2, historial.length);
        
        // Calcular posici√≥n y altura del contenedor virtual
        list.style.height = `${historial.length * ITEM_HEIGHT}px`;
        
        // Eliminar elementos no visibles
        const currentItems = Array.from(list.children);
        currentItems.forEach(item => {
          const index = parseInt(item.dataset.index);
          if (index < startIndex || index >= endIndex) {
            item.remove();
          }
        });
        
        // Agregar elementos visibles
        for (let i = startIndex; i < endIndex; i++) {
          if (!document.querySelector(`.virtual-list-item[data-index="${i}"]`)) {
            const pedido = historial[i];
            const item = document.createElement('div');
            item.className = 'virtual-list-item pedido-card';
            item.dataset.index = i;
            item.style.top = `${i * ITEM_HEIGHT}px`;
            item.style.height = `${ITEM_HEIGHT}px`;
            item.innerHTML = `
              <h3>${pedido.cliente}</h3>
              <p><small>Archivado el: ${formatearFecha(pedido.fechaArchivado)}</small></p>
              <p>${pedido.direccion}</p>
              <p>Productos: ${pedido.productos}</p>
              <p>Tel: +503${pedido.telefono}</p>
              <p>Vendedor: ${pedido.vendedor} (Tel: +503${pedido.telefonoVendedor})</p>
              <p><small>Creado: ${formatearFecha(pedido.fechaCreacion)}</small></p>
            `;
            list.appendChild(item);
          }
        }
      }
      
      container.addEventListener('scroll', () => {
        requestAnimationFrame(renderVisibleItems);
      });
      
      // Renderizar inicialmente
      renderVisibleItems();
    }

    // Renderizar historial con virtualizaci√≥n
    function renderizarHistorial(lista = historial) {
      loadingSpinner.style.display = 'block';
      historialList.innerHTML = '';
      
      setTimeout(() => {
        if (lista.length === 0) {
          historialList.innerHTML = '<p>No hay pedidos archivados a√∫n.</p>';
          loadingSpinner.style.display = 'none';
          return;
        }
        
        historial = lista;
        setupVirtualList();
        loadingSpinner.style.display = 'none';
      }, 300);
    }

    // Filtrar historial por fecha
    function filtrarHistorialPorFecha(fecha) {
      if (!fecha) return historial;
      
      const fechaSeleccionada = new Date(fecha);
      return historial.filter(pedido => {
        const fechaArchivado = new Date(pedido.fechaArchivado);
        return compareDates(fechaArchivado, fechaSeleccionada);
      });
    }

    // Cambiar estado de pedido
    window.cambiarEstado = (id, estado) => {
      const pedido = pedidos.find(p => p.id === id);
      if (pedido) {
        pedido.estado = estado;
        if (estado === 'entregado') {
          const mensaje = `‚úÖ Pedido entregado üôÇ¬°Hazlo f√°cil con Vidri!`;
          enviarWhatsApp(pedido.telefonoVendedor, mensaje);
        } else if (estado === 'no_entregado') {
          const mensaje = `‚ùå Pedido NO entregado\n\nCliente: ${pedido.cliente}\nDirecci√≥n: ${pedido.direccion}\nProductos: ${pedido.productos}\n\nPor favor contactar al cliente: +503${pedido.telefono}`;
          enviarWhatsApp(pedido.telefonoVendedor, mensaje);
        }
        renderizarPedidos();
      }
    };

    // Archivar pedido
    window.archivarPedido = (id) => {
      const pedidoIndex = pedidos.findIndex(p => p.id === id);
      if (pedidoIndex !== -1) {
        const pedido = pedidos[pedidoIndex];
        pedido.fechaArchivado = new Date();
        historial.unshift(pedido);
        pedidos.splice(pedidoIndex, 1);
        renderizarPedidos();
        renderizarHistorial();
        guardarDatos();
      }
    };

    // Guardar todos los datos
    function guardarDatos() {
      localStorage.setItem('pedidos', JSON.stringify(pedidos));
      localStorage.setItem('historial', JSON.stringify(historial));
      localStorage.setItem('vendedores', JSON.stringify(vendedores));
      localStorage.setItem('theme', currentTheme);
    }

    // Configurar men√∫ hamburguesa y temas
    function setupMenu() {
      const hamburgerMenu = document.getElementById('hamburger-menu');
      const sidebar = document.getElementById('sidebar');
      
      hamburgerMenu.addEventListener('click', () => {
        sidebar.classList.add('active');
      });
      
      // Configurar tema
      document.body.classList.add(`${currentTheme}-theme`);
      document.getElementById('theme-select').value = currentTheme;
      
      document.getElementById('theme-select').addEventListener('change', (e) => {
        document.body.classList.remove(`${currentTheme}-theme`);
        currentTheme = e.target.value;
        document.body.classList.add(`${currentTheme}-theme`);
        localStorage.setItem('theme', currentTheme);
      });
      
      // Configurar gesti√≥n de vendedores
      setupVendedores();
    }

    // Configurar gesti√≥n de vendedores
    function setupVendedores() {
      const vendedorNombreInputSidebar = document.getElementById('vendedor-nombre-input');
      const vendedorTelefonoInputSidebar = document.getElementById('vendedor-telefono-input');
      const addVendedorBtn = document.getElementById('add-vendedor-btn');
      const vendedoresList = document.getElementById('vendedores-list');
      
      // Renderizar lista de vendedores
      function renderVendedores() {
        vendedoresList.innerHTML = '';
        vendedores.forEach((vendedor, index) => {
          const li = document.createElement('li');
          li.innerHTML = `
            <span>${vendedor.nombre} - ${vendedor.telefono}</span>
            <button onclick="eliminarVendedor(${index})" title="Eliminar">√ó</button>
          `;
          vendedoresList.appendChild(li);
        });
        localStorage.setItem('vendedores', JSON.stringify(vendedores));
        updateVendedorDropdown();
      }
      
      // Agregar nuevo vendedor
      addVendedorBtn.addEventListener('click', () => {
        const nombre = vendedorNombreInputSidebar.value.trim();
        const telefono = vendedorTelefonoInputSidebar.value.trim();
        
        if (nombre && telefono && telefono.length === 8) {
          vendedores.push({ nombre, telefono });
          vendedorNombreInputSidebar.value = '';
          vendedorTelefonoInputSidebar.value = '';
          renderVendedores();
        } else {
          alert('Por favor ingrese un nombre y tel√©fono v√°lido (8 d√≠gitos)');
        }
      });
      
      renderVendedores();
    }

    // Actualizar dropdown de vendedores en formulario
    function updateVendedorDropdown() {
      const datalist = document.getElementById('vendedores-data');
      if (!datalist) return;
      
      datalist.innerHTML = vendedores.map(v => 
        `<option value="${v.nombre}" data-telefono="${v.telefono}">${v.nombre} - ${v.telefono}</option>`
      ).join('');
      
      // Actualizar ambos campos cuando seleccionan vendedor
      const vendedorInput = document.querySelector('input[list="vendedores-data"]');
      if (vendedorInput) {
        vendedorInput.addEventListener('input', (e) => {
          const selectedOption = Array.from(datalist.options).find(opt => 
            opt.value === e.target.value
          );
          
          if (selectedOption) {
            const telefono = selectedOption.dataset.telefono;
            const telefonoInput = document.getElementById('vendedor-telefono');
            if (telefonoInput) {
              telefonoInput.value = telefono;
            }
          }
        });
      }
    }

    // Eliminar vendedor
    window.eliminarVendedor = (index) => {
      if (confirm('¬øEliminar este vendedor?')) {
        vendedores.splice(index, 1);
        const renderVendedores = () => {
          document.getElementById('vendedores-list').innerHTML = '';
          vendedores.forEach((vendedor, i) => {
            const li = document.createElement('li');
            li.innerHTML = `
              <span>${vendedor.nombre} - ${vendedor.telefono}</span>
              <button onclick="eliminarVendedor(${i})" title="Eliminar">√ó</button>
            `;
            document.getElementById('vendedores-list').appendChild(li);
          });
          localStorage.setItem('vendedores', JSON.stringify(vendedores));
          updateVendedorDropdown();
        };
        renderVendedores();
      }
    };

    // Configurar b√∫squeda con debounce
    function setupSearch() {
      searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          const term = e.target.value.toLowerCase();
          const filtered = pedidos.filter(p => 
            p.cliente.toLowerCase().includes(term) || 
            p.direccion.toLowerCase().includes(term) ||
            p.productos.toLowerCase().includes(term) ||
            p.vendedor.toLowerCase().includes(term)
          );
          renderizarPedidos(filtered);
        }, 300);
      });
    }

    // Eventos de los modales
    function setupModalTriggers() {
      // Mostrar modal de registro
      addPedidoBtn.addEventListener('click', () => {
        registroModal.style.display = 'flex';
        updateVendedorDropdown();
      });

      // Ocultar modal de registro al hacer clic fuera
      window.addEventListener('click', (e) => {
        if (e.target === registroModal) {
          registroModal.style.display = 'none';
        }
        if (e.target === historialModal) {
          historialModal.style.display = 'none';
        }
        if (e.target === document.getElementById('sidebar')) {
          document.getElementById('sidebar').classList.remove('active');
        }
      });

      // Mostrar/ocultar submenu de historial
      showHistorialBtn.addEventListener('click', () => {
        historialSubmenu.classList.toggle('active');
      });

      // Mostrar calendario en historial
      showCalendarBtn.addEventListener('click', () => {
        historialTitle.textContent = 'Historial por Fecha';
        calendarContainer.style.display = 'block';
        renderizarHistorial();
        historialModal.style.display = 'flex';
        document.getElementById('sidebar').classList.remove('active');
        historialSubmenu.classList.remove('active');
      });

      // Mostrar historial reciente
      showRecentBtn.addEventListener('click', () => {
        historialTitle.textContent = 'Historial Reciente';
        calendarContainer.style.display = 'none';
        renderizarHistorial();
        historialModal.style.display = 'flex';
        document.getElementById('sidebar').classList.remove('active');
        historialSubmenu.classList.remove('active');
      });

      // Filtrar por fecha
      filterDateBtn.addEventListener('click', () => {
        const fechaSeleccionada = historialDate.value;
        if (fechaSeleccionada) {
          const historialFiltrado = filtrarHistorialPorFecha(fechaSeleccionada);
          renderizarHistorial(historialFiltrado);
        }
      });

      // Mostrar todo el historial
      showAllHistorial.addEventListener('click', () => {
        renderizarHistorial();
      });

      // Ocultar modal de historial
      closeHistorialBtn.addEventListener('click', () => {
        historialModal.style.display = 'none';
      });
    }

    // Configurar validaci√≥n de tel√©fonos - FUNCI√ìN CORREGIDA
    function setupPhoneValidation() {
      document.querySelectorAll('input[type="tel"]').forEach(input => {
        input.addEventListener('input', (e) => {
          // Limpiar el valor manteniendo solo d√≠gitos
          let cleanedValue = e.target.value.replace(/\D/g, '');
          
          // Limitar a 8 d√≠gitos
          cleanedValue = cleanedValue.slice(0, 8);
          
          // Actualizar el valor del campo
          e.target.value = cleanedValue;
          
          // Si es el campo de tel√©fono del cliente, buscar cliente frecuente
          if (e.target.id === 'cliente-telefono' && cleanedValue.length === 8) {
            buscarClienteFrecuente(cleanedValue);
          }
        });
      });
    }

    // Guardar nuevo pedido - FUNCI√ìN CORREGIDA
    function setupFormSubmit() {
      pedidoForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        // Obtener valores limpios de los tel√©fonos
        const telefonoCliente = clienteTelefonoInput.value.replace(/\D/g, '');
        const telefonoVendedor = document.getElementById('vendedor-telefono').value.replace(/\D/g, '');
        
        // Validar tel√©fonos
        if (telefonoCliente.length !== 8 || telefonoVendedor.length !== 8) {
          alert('Por favor ingrese n√∫meros de tel√©fono v√°lidos (8 d√≠gitos)');
          return;
        }
        
        // Extraer solo el nombre del vendedor si viene con tel√©fono
        let nombreVendedor = document.getElementById('vendedor-nombre').value;
        
        // Crear nuevo pedido
        const nuevoPedido = {
          id: Date.now(),
          cliente: clienteNombreInput.value.trim(),
          direccion: clienteDireccionInput.value.trim(),
          telefono: telefonoCliente,
          productos: clienteProductosInput.value.trim(),
          vendedor: nombreVendedor,
          telefonoVendedor: telefonoVendedor,
          estado: 'pendiente',
          fechaCreacion: new Date()
        };
        
        // Agregar el pedido y actualizar la vista
        pedidos.push(nuevoPedido);
        registroModal.style.display = 'none';
        pedidoForm.reset();
        renderizarPedidos();
        guardarDatos();
        
        // Notificar al vendedor
        const mensajeVendedor = `üì¶ Nuevo pedido registrado va en rutaüöõ\n\nCliente: ${nuevoPedido.cliente}\nDirecci√≥n: ${nuevoPedido.direccion}\nProductos: ${nuevoPedido.productos}\n\nTel√©fono del cliente: +503${nuevoPedido.telefono}`;
        enviarWhatsApp(nuevoPedido.telefonoVendedor, mensajeVendedor);
      });
    }

    // Configurar detecci√≥n de cliente frecuente
    function setupClienteFrecuente() {
      clienteTelefonoInput.addEventListener('input', (e) => {
        const telefono = e.target.value.replace(/\D/g, '');
        if (telefono.length === 8) {
          buscarClienteFrecuente(telefono);
        } else {
          clienteFrecuenteDiv.style.display = 'none';
        }
      });
      
      usarClienteBtn.addEventListener('click', usarInfoCliente);
    }

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', () => {
      setupMenu();
      setupModalTriggers();
      setupFormSubmit();
      setupPhoneValidation();
      setupSearch();
      setupClienteFrecuente();
      setupBackground();
      setupConfirmacionEntrega();
      renderizarPedidos();
    });
  </script>
</body>
</html>
